---
title: "Glossy Buckthorn CA"
author: "Tim Szewczyk"
date: "`r Sys.Date()`"
output: github_document
---

This is a wrapper for running the glossy buckthorn cellular automata model. It sets up the environment, allows the assignment of all necessary parameters, runs the simulation, and visualizes the results.

The land cover within each cell is compositional rather than the more common hard classification. As a result, all land cover-specific parameters are computed proportionally to the land cover in a cell (i.e., lc.prop %*% K, where lc.prop is a matrix with columns for land cover and a row for each cell, and K is a vector of carrying capacities with one per land cover type).

```{r setup, include=FALSE}
if(!require(sevcheck)) devtools::install_github("Sz-Tim/sevcheck")
p_load("tidyverse", "magrittr", "stringr", "parallel", "pbapply", "fastmatch")
theme_set(theme_bw())
source("code/ca_fn.R")
```


```{r setPars}
##---
## set parameters
##---

  set.seed(225)
  n.sim <- 1
  blockSize <- 5  # number of acres per block (width & height)
  cb.i <- make_cb_i(blockSize); summary(cb.i)
  g.p <- list(
    # general
    tmax=35,  # num time steps per simulation
    dem.st=FALSE,  # include stochasticity in demography?
    sdd.st=TRUE,  # include stochasticity in SDD?
    simple=FALSE,  # simple lambda growth vs. fruits/seeds
    n_cores=4,  # parallelize sdd.pr calculation
    
    # landscape
    lc.r=81,  # num rows in landscape
    lc.c=108,  # num columns in landscape
    n.lc=6,  # num land cover categories
    N.p.t0=50,  # num cells with buckthorn at t=1
    
    # demography
    K=c(750, 10, 100, 100, 300, 100),  # K for 8+
    K.y=rbind(seq(2000, 750, length.out=7),  # K for 1-7; OpI
              seq(100, 10, length.out=7),  # K for 1-7; OpU
              seq(1000, 100, length.out=7),  # K for 1-7; Dec
              seq(1000, 300, length.out=7),  # K for 1-7; WP
              seq(1000, 100, length.out=7),  # K for 1-7; Evg
              seq(1000, 100, length.out=7)),  # K for 1-7; Mxd
    # pr.s=rbind(seq(0.9, 0.95, length.out=7),
    #            seq(0.1, 0.5, length.out=7),
    #            seq(0.4, 0.9, length.out=7),
    #            seq(0.7, 0.95, length.out=7),
    #            seq(0.4, 0.9, length.out=7),
    #            seq(0.4, 0.9, length.out=7)),  # pre-adult survival
    pr.f=c(0.9, 0.1, 0.29, 0.23, 0.2, 0.3),  # pr(fruit)
    fec=c(200, 100, 40, 20, 20, 10),  # mean(fruit per adult)
    age.mat=c(3, 3, 7, 7, 7, 7),  # mean age at first fruiting
    bank=TRUE,  # include seedbank?
    pr.sb=rep(0.3, 6),  # pr(ann.surv seed bank)
    pr.est=c(0.07, 0.01, 0.08, 0.02, 0.02, 0.03),  # pr(seedling est)
    lambda=c(2.5, 0.5, 1.1, 1.1, 1.8, 1.3),  # pop growth rate
    
    # dispersal
    sdd.max=25,  # max dispersal distance (unit: cells)
    sdd.rate=0.001,  # 1/mn for dispersal kernel
    trunc.diag=TRUE,  # restrict dispersal to sdd.max radius
    pr.eat=c(0.6, 0.5, 0.5, 0.25, 0.2, 0.8),  # pr(birds eat frt)
    bird.hab=c(0.2, 0.2, 0.5, 2, 0.8, 0.5),  # bird habitat prefs
    n.ldd=1   # num long distance dispersal events per year
  )
  

##--
## initialize landscape
##--
  
  # land cover
  ncell <- g.p$lc.r*g.p$lc.c
  Block.inc <- cb.i$BlockID[cb.i$BlockCol <= g.p$lc.c &
                            cb.i$BlockRow <= g.p$lc.r] %>% unique
  
  grnt <- read_csv(paste0("data/out_01_1a_grnt.csv")) %>% 
    mutate(CellID=1:nrow(.)) %>% add_blocks(cb.i=cb.i) %>% 
    summarise(Dev=sum(V1)/n(), Oth=sum(V2)/n(), Hwd=sum(V3)/n(), 
              WP=sum(V4)/n(), Evg=sum(V5)/n(), Mxd=sum(V6)/n()) %>%
    filter(BlockID %in% Block.inc) 
  
  lc.df <- tibble(x=cb.i$BlockCol[match(grnt$BlockID, cb.i$BlockID)],
                  y=cb.i$BlockRow[match(grnt$BlockID, cb.i$BlockID)],
                  x_y=paste(x,y,sep="_"),
                  Dev=grnt$Dev, Oth=grnt$Oth, Hwd=grnt$Hwd,
                  WP=grnt$WP, Evg=grnt$Evg, Mxd=grnt$Mxd)
  
  # populations
  N.init <- matrix(0, ncell, 8)  # ages 1-7, adults
  p.0 <- sample(1:ncell, g.p$N.p.t0)
  N.init[p.0,8] <- (as.matrix(lc.df[p.0,4:9]) %*% (g.p$K/4)) %>% round
  N.init[p.0,1:7] <- (N.init[p.0,8]/10) %>% round
  
  # dispersal probabilities
  system.time(sdd.pr <- sdd_set_probs(lc.df, g.p))
```

```{r runSim}
system.time(
for(s in 1:n.sim) {
  out <- run_sim(g.p, lc.df, sdd.pr, N.init, control.p=NULL)
}
)
```


```{r plots, fig.height=8, fig.width=10}
out.ad <- out[,,8]
colnames(out.ad) <- paste0("t_", 1:ncol(out.ad))
N.out <- cbind(lc.df, out.ad) %>% as.tibble

ggplot(N.out, aes(x=x, y=y, fill=t_35)) + 
    geom_tile() + 
    scale_fill_gradient(low="white", high="red", 
                        limits=range(out.ad[,-ncol(out.ad)]))

# buckthorn abundance
for(t in 1:g.p$tmax) {
  p.t <- ggplot(N.out, aes(x=x, y=y)) + 
    geom_tile(aes_string(fill=paste0("t_", t))) + 
    scale_fill_gradient(low="white", high="red",
                        limits=range(out.ad[,-ncol(out.ad)]))
  print(p.t)
  # ggsave(paste0("out/plots/n_", ncell, "_t_", t, ".jpg"),
  #        p.t, width=10, height=7)
}

N.out$lam <- as.matrix(lc.df[,4:9]) %*% g.p$lambda
ggplot(N.out, aes(x=x, y=y, fill=lam)) + geom_tile() +
  scale_fill_gradient2(midpoint=1)

# land cover
p.dev <- ggplot(N.out, aes(x=x, y=y, fill=Dev)) + geom_tile() + 
  scale_fill_gradient(low="white", high="red", limits=c(0,1))
ggsave(paste0("out/plots/n_", ncell, "_LC_Dev.jpg"), p.dev,
         width=10, height=7)

p.oth <- ggplot(N.out, aes(x=x, y=y, fill=Oth)) + geom_tile() + 
  scale_fill_gradient(low="white", high="gray30", limits=c(0,1))
ggsave(paste0("out/plots/n_", ncell, "_LC_Oth.jpg"), p.oth,
         width=10, height=7)

p.hwd <- ggplot(N.out, aes(x=x, y=y, fill=Hwd)) + geom_tile() + 
  scale_fill_gradient(low="white", high="green3", limits=c(0,1))
ggsave(paste0("out/plots/n_", ncell, "_LC_Hwd.jpg"), p.hwd,
         width=10, height=7)

p.wp <- ggplot(N.out, aes(x=x, y=y, fill=WP)) + geom_tile() + 
  scale_fill_gradient(low="white", high="orchid", limits=c(0,1))
ggsave(paste0("out/plots/n_", ncell, "_LC_WP.jpg"), p.wp,
         width=10, height=7)

p.evg <- ggplot(N.out, aes(x=x, y=y, fill=Evg)) + geom_tile() + 
  scale_fill_gradient(low="white", high="darkgreen", limits=c(0,1))
ggsave(paste0("out/plots/n_", ncell, "_LC_Evg.jpg"), p.evg,
         width=10, height=7)

p.mxd <- ggplot(N.out, aes(x=x, y=y, fill=Mxd)) + geom_tile() + 
  scale_fill_gradient(low="white", high="yellowgreen", limits=c(0,1))
ggsave(paste0("out/plots/n_", ncell, "_LC_Mxd.jpg"), p.mxd,
         width=10, height=7)


# buckthorn vs land cover
ggplot(N.out, aes(x=Dev)) + 
  geom_point(aes_string(y=paste0("t_", g.p$tmax)), alpha=0.1)
ggplot(N.out, aes(x=Oth)) + 
  geom_point(aes_string(y=paste0("t_", g.p$tmax)), alpha=0.1)
ggplot(N.out, aes(x=Hwd)) + 
  geom_point(aes_string(y=paste0("t_", g.p$tmax)), alpha=0.1)
ggplot(N.out, aes(x=WP)) + 
  geom_point(aes_string(y=paste0("t_", g.p$tmax)), alpha=0.1)
ggplot(N.out, aes(x=Evg)) + 
  geom_point(aes_string(y=paste0("t_", g.p$tmax)), alpha=0.1)
ggplot(N.out, aes(x=Mxd)) + 
  geom_point(aes_string(y=paste0("t_", g.p$tmax)), alpha=0.1)
```




